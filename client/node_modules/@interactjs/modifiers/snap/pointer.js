import * as utils from '@interactjs/utils';
function start(arg) {
    const { interaction, interactable, element, rect, state, startOffset } = arg;
    const { options } = state;
    const offsets = [];
    const origin = options.offsetWithOrigin
        ? getOrigin(arg)
        : { x: 0, y: 0 };
    let snapOffset;
    if (options.offset === 'startCoords') {
        snapOffset = {
            x: interaction.coords.start.page.x,
            y: interaction.coords.start.page.y,
        };
    }
    else {
        const offsetRect = utils.rect.resolveRectLike(options.offset, interactable, element, [interaction]);
        snapOffset = utils.rect.rectToXY(offsetRect) || { x: 0, y: 0 };
        snapOffset.x += origin.x;
        snapOffset.y += origin.y;
    }
    const relativePoints = options.relativePoints || [];
    if (rect && options.relativePoints && options.relativePoints.length) {
        for (let index = 0; index < relativePoints.length; index++) {
            const relativePoint = relativePoints[index];
            offsets.push({
                index,
                relativePoint,
                x: startOffset.left - (rect.width * relativePoint.x) + snapOffset.x,
                y: startOffset.top - (rect.height * relativePoint.y) + snapOffset.y,
            });
        }
    }
    else {
        offsets.push(utils.extend({
            index: 0,
            relativePoint: null,
        }, snapOffset));
    }
    state.offsets = offsets;
}
function set(arg) {
    const { interaction, coords, state } = arg;
    const { options, offsets } = state;
    const origin = utils.getOriginXY(interaction.interactable, interaction.element, interaction.prepared.name);
    const page = utils.extend({}, coords);
    const targets = [];
    let target;
    if (!options.offsetWithOrigin) {
        page.x -= origin.x;
        page.y -= origin.y;
    }
    state.realX = page.x;
    state.realY = page.y;
    for (const offset of offsets) {
        const relativeX = page.x - offset.x;
        const relativeY = page.y - offset.y;
        for (let index = 0, len = options.targets.length; index < len; index++) {
            const snapTarget = options.targets[index];
            if (utils.is.func(snapTarget)) {
                target = snapTarget(relativeX, relativeY, interaction, offset, index);
            }
            else {
                target = snapTarget;
            }
            if (!target) {
                continue;
            }
            targets.push({
                x: (utils.is.number(target.x) ? target.x : relativeX) + offset.x,
                y: (utils.is.number(target.y) ? target.y : relativeY) + offset.y,
                range: utils.is.number(target.range) ? target.range : options.range,
            });
        }
    }
    const closest = {
        target: null,
        inRange: false,
        distance: 0,
        range: 0,
        dx: 0,
        dy: 0,
    };
    for (let i = 0, len = targets.length; i < len; i++) {
        target = targets[i];
        const range = target.range;
        const dx = target.x - page.x;
        const dy = target.y - page.y;
        const distance = utils.hypot(dx, dy);
        let inRange = distance <= range;
        // Infinite targets count as being out of range
        // compared to non infinite ones that are in range
        if (range === Infinity && closest.inRange && closest.range !== Infinity) {
            inRange = false;
        }
        if (!closest.target || (inRange
            // is the closest target in range?
            ? (closest.inRange && range !== Infinity
                // the pointer is relatively deeper in this target
                ? distance / range < closest.distance / closest.range
                // this target has Infinite range and the closest doesn't
                : (range === Infinity && closest.range !== Infinity) ||
                    // OR this target is closer that the previous closest
                    distance < closest.distance)
            // The other is not in range and the pointer is closer to this target
            : (!closest.inRange && distance < closest.distance))) {
            closest.target = target;
            closest.distance = distance;
            closest.range = range;
            closest.inRange = inRange;
            closest.dx = dx;
            closest.dy = dy;
            state.range = range;
        }
    }
    if (closest.inRange) {
        coords.x = closest.target.x;
        coords.y = closest.target.y;
    }
    state.closest = closest;
}
function getOrigin(arg) {
    const optionsOrigin = utils.rect.rectToXY(utils.rect.resolveRectLike(arg.state.options.origin, [arg.interaction.element]));
    const origin = optionsOrigin || utils.getOriginXY(arg.interactable, arg.interaction.element, arg.interaction.prepared.name);
    return origin;
}
const defaults = {
    range: Infinity,
    targets: null,
    offset: null,
    offsetWithOrigin: true,
    origin: null,
    relativePoints: null,
    endOnly: false,
    enabled: false,
};
const snap = {
    start,
    set,
    defaults,
};
export default snap;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9pbnRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInBvaW50ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEtBQUssTUFBTSxtQkFBbUIsQ0FBQTtBQXdDMUMsU0FBUyxLQUFLLENBQUUsR0FBMkI7SUFDekMsTUFBTSxFQUFFLFdBQVcsRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFLEdBQUcsR0FBRyxDQUFBO0lBQzVFLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxLQUFLLENBQUE7SUFDekIsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFBO0lBQ2xCLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0I7UUFDckMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUM7UUFDaEIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUE7SUFFbEIsSUFBSSxVQUFVLENBQUE7SUFFZCxJQUFJLE9BQU8sQ0FBQyxNQUFNLEtBQUssYUFBYSxFQUFFO1FBQ3BDLFVBQVUsR0FBRztZQUNYLENBQUMsRUFBRSxXQUFXLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNsQyxDQUFDLEVBQUUsV0FBVyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDbkMsQ0FBQTtLQUNGO1NBQ0s7UUFDSixNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsTUFBYSxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFBO1FBRTFHLFVBQVUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMs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QUN0QixNQUFNLEVBQUUsSUFBSTtJQUNaLGNBQWMsRUFBRSxJQUFJO0lBQ3BCLE9BQU8sRUFBRSxLQUFLO0lBQ2QsT0FBTyxFQUFFLEtBQUs7Q0FDZixDQUFBO0FBQ0QsTUFBTSxJQUFJLEdBQUc7SUFDWCxLQUFLO0lBQ0wsR0FBRztJQUNILFFBQVE7Q0FDVCxDQUFBO0FBRUQsZUFBZSxJQUFJLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB1dGlscyBmcm9tICdAaW50ZXJhY3Rqcy91dGlscydcbmltcG9ydCB7IE1vZGlmaWVyQXJnLCBNb2RpZmllclN0YXRlIH0gZnJvbSAnLi4vYmFzZSdcblxuZXhwb3J0IGludGVyZmFjZSBTbmFwUG9zaXRpb24ge1xuICB4OiBudW1iZXJcbiAgeTogbnVtYmVyXG4gIHJhbmdlPzogbnVtYmVyXG59XG5cbmV4cG9ydCB0eXBlIFNuYXBGdW5jdGlvbiA9IChcbiAgeDogbnVtYmVyLFxuICB5OiBudW1iZXIsXG4gIGludGVyYWN0aW9uOiBJbnRlcmFjdC5JbnRlcmFjdGlvbixcbiAgb2Zmc2V0OiBJbnRlcmFjdC5Qb2ludCxcbiAgaW5kZXg6IG51bWJlclxuKSA9PiBTbmFwUG9zaXRpb25cbmV4cG9ydCB0eXBlIFNuYXBUYXJnZXQgPSBTbmFwUG9zaXRpb24gfCBTbmFwRnVuY3Rpb25cbmV4cG9ydCBpbnRlcmZhY2UgU25hcE9wdGlvbnMge1xuICB0YXJnZXRzOiBTbmFwVGFyZ2V0W11cbiAgLy8gdGFyZ2V0IHJhbmdlXG4gIHJhbmdlOiBudW1iZXJcbiAgLy8gc2VsZiBwb2ludHMgZm9yIHNuYXBwaW5nLiBbMCwwXSA9IHRvcCBsZWZ0LCBbMSwxXSA9IGJvdHRvbSByaWdodFxuICByZWxhdGl2ZVBvaW50czogSW50ZXJhY3QuUG9pbnRbXVxuICAvLyBzdGFydENvb3JkcyA9IG9mZnNldCBzbmFwcGluZyBmcm9tIGRyYWcgc3RhcnQgcGFnZSBwb3NpdGlvblxuICBvZmZzZXQ6IEludGVyYWN0LlBvaW50IHwgSW50ZXJhY3QuUmVjdFJlc29sdmFibGU8W0ludGVyYWN0LkludGVyYWN0aW9uXT4gfCAnc3RhcnRDb29yZHMnXG4gIG9mZnNldFdpdGhPcmlnaW4/OiBib29sZWFuXG4gIG9yaWdpbjogSW50ZXJhY3QuUmVjdFJlc29sdmFibGU8W0VsZW1lbnRdPiB8IEludGVyYWN0LlBvaW50XG4gIGVuZE9ubHk/OiBib29sZWFuXG4gIGVuYWJsZWQ/OiBib29sZWFuXG59XG5cbmV4cG9ydCB0eXBlIFNuYXBTdGF0ZSA9IE1vZGlmaWVyU3RhdGU8U25hcE9wdGlvbnMsIHtcbiAgb2Zmc2V0cz86IEludGVyYWN0LlBvaW50W11cbiAgcmVhbFg/OiBudW1iZXJcbiAgcmVhbFk/OiBudW1iZXJcbiAgcmFuZ2U/OiBudW1iZXJcbiAgY2xvc2VzdD86IGFueVxuICB0YXJnZXRGaWVsZHM/OiBzdHJpbmdbXVtdXG59PlxuXG5mdW5jdGlvbiBzdGFydCAoYXJnOiBNb2RpZmllckFyZzxTbmFwU3RhdGU+KSB7XG4gIGNvbnN0IHsgaW50ZXJhY3Rpb24sIGludGVyYWN0YWJsZSwgZWxlbWVudCwgcmVjdCwgc3RhdGUsIHN0YXJ0T2Zmc2V0IH0gPSBhcmdcbiAgY29uc3QgeyBvcHRpb25zIH0gPSBzdGF0ZVxuICBjb25zdCBvZmZzZXRzID0gW11cbiAgY29uc3Qgb3JpZ2luID0gb3B0aW9ucy5vZmZzZXRXaXRoT3JpZ2luXG4gICAgPyBnZXRPcmlnaW4oYXJnKVxuICAgIDogeyB4OiAwLCB5OiAwIH1cblxuICBsZXQgc25hcE9mZnNldFxuXG4gIGlmIChvcHRpb25zLm9mZnNldCA9PT0gJ3N0YXJ0Q29vcmRzJykge1xuICAgIHNuYXBPZmZzZXQgPSB7XG4gICAgICB4OiBpbnRlcmFjdGlvbi5jb29yZHMuc3RhcnQucGFnZS54LFxuICAgICAgeTogaW50ZXJhY3Rpb24uY29vcmRzLnN0YXJ0LnBhZ2UueSxcbiAgICB9XG4gIH1cbiAgZWxzZSAge1xuICAgIGNvbnN0IG9mZnNldFJlY3QgPSB1dGlscy5yZWN0LnJlc29sdmVSZWN0TGlrZShvcHRpb25zLm9mZnNldCBhcyBhbnksIGludGVyYWN0YWJsZSwgZWxlbWVudCwgW2ludGVyYWN0aW9uXSlcblxuICAgIHNuYXBPZmZzZXQgPSB1dGlscy5yZWN0LnJlY3RUb1hZKG9mZnNldFJlY3QpIHx8IHsgeDogMCwgeTogMCB9XG4gICAgc25hcE9mZnNldC54ICs9IG9yaWdpbi54XG4gICAgc25hcE9mZnNldC55ICs9IG9yaWdpbi55XG4gIH1cblxuICBjb25zdCByZWxhdGl2ZVBvaW50cyA9IG9wdGlvbnMucmVsYXRpdmVQb2ludHMgfHwgW11cblxuICBpZiAocmVjdCAmJiBvcHRpb25zLnJlbGF0aXZlUG9pbnRzICYmIG9wdGlvbnMucmVsYXRpdmVQb2ludHMubGVuZ3RoKSB7XG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHJlbGF0aXZlUG9pbnRzLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgY29uc3QgcmVsYXRpdmVQb2ludCA9IHJlbGF0aXZlUG9pbnRzW2luZGV4XVxuXG4gICAgICBvZmZzZXRzLnB1c2goe1xuICAgICAgICBpbmRleCxcbiAgICAgICAgcmVsYXRpdmVQb2ludCxcbiAgICAgICAgeDogc3RhcnRPZmZzZXQubGVmdCAtIChyZWN0LndpZHRoICAqIHJlbGF0aXZlUG9pbnQueCkgKyBzbmFwT2Zmc2V0LngsXG4gICAgICAgIHk6IHN0YXJ0T2Zmc2V0LnRvcCAgLSAocmVjdC5oZWlnaHQgKiByZWxhdGl2ZVBvaW50LnkpICsgc25hcE9mZnNldC55LFxuICAgICAgfSlcbiAgICB9XG4gIH1cbiAgZWxzZSB7XG4gICAgb2Zmc2V0cy5wdXNoKHV0aWxzLmV4dGVuZCh7XG4gICAgICBpbmRleDogMCxcbiAgICAgIHJlbGF0aXZlUG9pbnQ6IG51bGwsXG4gICAgfSwgc25hcE9mZnNldCkpXG4gIH1cblxuICBzdGF0ZS5vZmZzZXRzID0gb2Zmc2V0c1xufVxuXG5mdW5jdGlvbiBzZXQgKGFyZzogTW9kaWZpZXJBcmc8U25hcFN0YXRlPikge1xuICBjb25zdCB7IGludGVyYWN0aW9uLCBjb29yZHMsIHN0YXRlIH0gPSBhcmdcbiAgY29uc3QgeyBvcHRpb25zLCBvZmZzZXRzIH0gPSBzdGF0ZVxuXG4gIGNvbnN0IG9yaWdpbiA9IHV0aWxzLmdldE9yaWdpblhZKGludGVyYWN0aW9uLmludGVyYWN0YWJsZSwgaW50ZXJhY3Rpb24uZWxlbWVudCwgaW50ZXJhY3Rpb24ucHJlcGFyZWQubmFtZSlcbiAgY29uc3QgcGFnZSA9IHV0aWxzLmV4dGVuZCh7fSwgY29vcmRzKVxuICBjb25zdCB0YXJnZXRzID0gW11cbiAgbGV0IHRhcmdldFxuXG4gIGlmICghb3B0aW9ucy5vZmZzZXRXaXRoT3JpZ2luKSB7XG4gICAgcGFnZS54IC09IG9yaWdpbi54XG4gICAgcGFnZS55IC09IG9yaWdpbi55XG4gIH1cblxuICBzdGF0ZS5yZWFsWCA9IHBhZ2UueFxuICBzdGF0ZS5yZWFsWSA9IHBhZ2UueVxuXG4gIGZvciAoY29uc3Qgb2Zmc2V0IG9mIG9mZnNldHMpIHtcbiAgICBjb25zdCByZWxhdGl2ZVggPSBwYWdlLnggLSBvZmZzZXQueFxuICAgIGNvbnN0IHJlbGF0aXZlWSA9IHBhZ2UueSAtIG9mZnNldC55XG5cbiAgICBmb3IgKGxldCBpbmRleCA9IDAsIGxlbiA9IG9wdGlvbnMudGFyZ2V0cy5sZW5ndGg7IGluZGV4IDwgbGVuOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCBzbmFwVGFyZ2V0ID0gb3B0aW9ucy50YXJnZXRzW2luZGV4XVxuICAgICAgaWYgKHV0aWxzLmlzLmZ1bmMoc25hcFRhcmdldCkpIHtcbiAgICAgICAgdGFyZ2V0ID0gc25hcFRhcmdldChyZWxhdGl2ZVgsIHJlbGF0aXZlWSwgaW50ZXJhY3Rpb24sIG9mZnNldCwgaW5kZXgpXG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgdGFyZ2V0ID0gc25hcFRhcmdldFxuICAgICAgfVxuXG4gICAgICBpZiAoIXRhcmdldCkgeyBjb250aW51ZSB9XG5cbiAgICAgIHRhcmdldHMucHVzaCh7XG4gICAgICAgIHg6ICh1dGlscy5pcy5udW1iZXIodGFyZ2V0LngpID8gdGFyZ2V0LnggOiByZWxhdGl2ZVgpICsgb2Zmc2V0LngsXG4gICAgICAgIHk6ICh1dGlscy5pcy5udW1iZXIodGFyZ2V0LnkpID8gdGFyZ2V0LnkgOiByZWxhdGl2ZVkpICsgb2Zmc2V0LnksXG5cbiAgICAgICAgcmFuZ2U6IHV0aWxzLmlzLm51bWJlcih0YXJnZXQucmFuZ2UpID8gdGFyZ2V0LnJhbmdlIDogb3B0aW9ucy5yYW5nZSxcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgY29uc3QgY2xvc2VzdCA9IHtcbiAgICB0YXJnZXQ6IG51bGwsXG4gICAgaW5SYW5nZTogZmFsc2UsXG4gICAgZGlzdGFuY2U6IDAsXG4gICAgcmFuZ2U6IDAsXG4gICAgZHg6IDAsXG4gICAgZHk6IDAsXG4gIH1cblxuICBmb3IgKGxldCBpID0gMCwgbGVuID0gdGFyZ2V0cy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgIHRhcmdldCA9IHRhcmdldHNbaV1cblxuICAgIGNvbnN0IHJhbmdlID0gdGFyZ2V0LnJhbmdlXG4gICAgY29uc3QgZHggPSB0YXJnZXQueCAtIHBhZ2UueFxuICAgIGNvbnN0IGR5ID0gdGFyZ2V0LnkgLSBwYWdlLnlcbiAgICBjb25zdCBkaXN0YW5jZSA9IHV0aWxzLmh5cG90KGR4LCBkeSlcbiAgICBsZXQgaW5SYW5nZSA9IGRpc3RhbmNlIDw9IHJhbmdlXG5cbiAgICAvLyBJbmZpbml0ZSB0YXJnZXRzIGNvdW50IGFzIGJlaW5nIG91dCBvZiByYW5nZVxuICAgIC8vIGNvbXBhcmVkIHRvIG5vbiBpbmZpbml0ZSBvbmVzIHRoYXQgYXJlIGluIHJhbmdlXG4gICAgaWYgKHJhbmdlID09PSBJbmZpbml0eSAmJiBjbG9zZXN0LmluUmFuZ2UgJiYgY2xvc2VzdC5yYW5nZSAhPT0gSW5maW5pdHkpIHtcbiAgICAgIGluUmFuZ2UgPSBmYWxzZVxuICAgIH1cblxuICAgIGlmICghY2xvc2VzdC50YXJnZXQgfHwgKGluUmFuZ2VcbiAgICAgIC8vIGlzIHRoZSBjbG9zZXN0IHRhcmdldCBpbiByYW5nZT9cbiAgICAgID8gKGNsb3Nlc3QuaW5SYW5nZSAmJiByYW5nZSAhPT0gSW5maW5pdHlcbiAgICAgICAgLy8gdGhlIHBvaW50ZXIgaXMgcmVsYXRpdmVseSBkZWVwZXIgaW4gdGhpcyB0YXJnZXRcbiAgICAgICAgPyBkaXN0YW5jZSAvIHJhbmdlIDwgY2xvc2VzdC5kaXN0YW5jZSAvIGNsb3Nlc3QucmFuZ2VcbiAgICAgICAgLy8gdGhpcyB0YXJnZXQgaGFzIEluZmluaXRlIHJhbmdlIGFuZCB0aGUgY2xvc2VzdCBkb2Vzbid0XG4gICAgICAgIDogKHJhbmdlID09PSBJbmZpbml0eSAmJiBjbG9zZXN0LnJhbmdlICE9PSBJbmZpbml0eSkgfHxcbiAgICAgICAgICAvLyBPUiB0aGlzIHRhcmdldCBpcyBjbG9zZXIgdGhhdCB0aGUgcHJldmlvdXMgY2xvc2VzdFxuICAgICAgICAgIGRpc3RhbmNlIDwgY2xvc2VzdC5kaXN0YW5jZSlcbiAgICAgIC8vIFRoZSBvdGhlciBpcyBub3QgaW4gcmFuZ2UgYW5kIHRoZSBwb2ludGVyIGlzIGNsb3NlciB0byB0aGlzIHRhcmdldFxuICAgICAgOiAoIWNsb3Nlc3QuaW5SYW5nZSAmJiBkaXN0YW5jZSA8IGNsb3Nlc3QuZGlzdGFuY2UpKSkge1xuICAgICAgY2xvc2VzdC50YXJnZXQgPSB0YXJnZXRcbiAgICAgIGNsb3Nlc3QuZGlzdGFuY2UgPSBkaXN0YW5jZVxuICAgICAgY2xvc2VzdC5yYW5nZSA9IHJhbmdlXG4gICAgICBjbG9zZXN0LmluUmFuZ2UgPSBpblJhbmdlXG4gICAgICBjbG9zZXN0LmR4ID0gZHhcbiAgICAgIGNsb3Nlc3QuZHkgPSBkeVxuXG4gICAgICBzdGF0ZS5yYW5nZSA9IHJhbmdlXG4gICAgfVxuICB9XG5cbiAgaWYgKGNsb3Nlc3QuaW5SYW5nZSkge1xuICAgIGNvb3Jkcy54ID0gY2xvc2VzdC50YXJnZXQueFxuICAgIGNvb3Jkcy55ID0gY2xvc2VzdC50YXJnZXQueVxuICB9XG5cbiAgc3RhdGUuY2xvc2VzdCA9IGNsb3Nlc3Rcbn1cblxuZnVuY3Rpb24gZ2V0T3JpZ2luIChhcmc6IFBhcnRpYWw8TW9kaWZpZXJBcmc8U25hcFN0YXRlPj4pIHtcbiAgY29uc3Qgb3B0aW9uc09yaWdpbiA9IHV0aWxzLnJlY3QucmVjdFRvWFkoXG4gICAgdXRpbHMucmVjdC5yZXNvbHZlUmVjdExpa2UoYXJnLnN0YXRlLm9wdGlvbnMub3JpZ2luIGFzIGFueSwgW2FyZy5pbnRlcmFjdGlvbi5lbGVtZW50XSlcbiAgKVxuICBjb25zdCBvcmlnaW4gPSBvcHRpb25zT3JpZ2luIHx8IHV0aWxzLmdldE9yaWdpblhZKFxuICAgIGFyZy5pbnRlcmFjdGFibGUsXG4gICAgYXJnLmludGVyYWN0aW9uLmVsZW1lbnQsXG4gICAgYXJnLmludGVyYWN0aW9uLnByZXBhcmVkLm5hbWUsXG4gIClcblxuICByZXR1cm4gb3JpZ2luXG59XG5cbmNvbnN0IGRlZmF1bHRzOiBTbmFwT3B0aW9ucyA9IHtcbiAgcmFuZ2UgIDogSW5maW5pdHksXG4gIHRhcmdldHM6IG51bGwsXG4gIG9mZnNldDogbnVsbCxcbiAgb2Zmc2V0V2l0aE9yaWdpbjogdHJ1ZSxcbiAgb3JpZ2luOiBudWxsLFxuICByZWxhdGl2ZVBvaW50czogbnVsbCxcbiAgZW5kT25seTogZmFsc2UsXG4gIGVuYWJsZWQ6IGZhbHNlLFxufVxuY29uc3Qgc25hcCA9IHtcbiAgc3RhcnQsXG4gIHNldCxcbiAgZGVmYXVsdHMsXG59XG5cbmV4cG9ydCBkZWZhdWx0IHNuYXBcbiJdfQ==